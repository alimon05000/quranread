<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mushaf Elite Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'KFGQPC';
            src: url('https://fonts.qurancomplex.gov.sa/wp-content/uploads/2020/04/KFGQPCUthmanicScript-Regular.otf') format('opentype');
        }

        :root {
            --bg: #0a0a0a;
            --gold: #b79a5b;
            --gold-light: rgba(183, 154, 91, 0.15);
            --border-gold: rgba(183, 154, 91, 0.3);
            --font-size: 32px;
        }

        body, html {
            margin: 0; padding: 0; background: var(--bg); color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif; height: 100%; overflow: hidden;
        }

        /* Меню */
        #menu { 
            height: 100vh; overflow-y: auto; padding: 20px; 
            max-width: 600px; margin: 0 auto; direction: ltr; 
        }
        .surah-card {
            background: linear-gradient(145deg, #111, #0a0a0a);
            padding: 20px; border-radius: 16px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid #222; cursor: pointer; transition: 0.3s;
        }

        /* Ридер и Свайп */
        #reader { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 1000; }
        .pages-container {
            display: flex; width: 100%; height: 100%;
            overflow-x: auto; overflow-y: hidden;
            scroll-snap-type: x mandatory; direction: rtl;
            -webkit-overflow-scrolling: touch;
        }
        .page {
            flex: 0 0 100%; width: 100%; height: 100%;
            scroll-snap-align: start; overflow-y: auto;
            background: radial-gradient(circle at 50% 50%, #0f0f0f, #070707);
        }
        .page-content { max-width: 800px; margin: 0 auto; padding: 80px 20px 150px; text-align: center; }

        /* Текст Корана */
        .quran-text {
            font-family: 'KFGQPC', 'Amiri', serif;
            line-height: 2.8; font-size: var(--font-size);
            word-spacing: 4px; color: #fcfcfc;
        }
        .ayah-wrapper { 
            padding: 15px 0; border-bottom: 1px solid transparent; 
            transition: background 0.3s; cursor: pointer; 
        }
        .ayah-wrapper:hover { background: rgba(183, 154, 91, 0.05); }
        .ayah-num { color: var(--gold); font-size: 0.7em; margin: 0 8px; font-family: 'serif'; }

        /* Премиальный Перевод */
        .translation { 
            direction: ltr; text-align: center; color: #e0e0e0;
            font-size: 1.05rem; margin: 20px auto; padding: 25px;
            max-width: 90%; line-height: 1.8;
            font-family: 'Amiri', serif; font-style: italic;
            background: linear-gradient(180deg, rgba(183,154,91,0.08) 0%, rgba(0,0,0,0) 100%);
            border-top: 1px solid var(--border-gold);
            position: relative; border-radius: 15px;
        }
        .translation::before { content: "“"; position: absolute; top: 10px; left: 10px; color: var(--gold); font-size: 30px; opacity: 0.5; }

        /* Заметки */
        .note-area {
            width: 90%; background: #111; color: #ddd; border: 1px dashed var(--border-gold);
            border-radius: 8px; padding: 10px; margin: 10px auto; display: none;
            font-family: 'Segoe UI'; font-size: 14px; direction: ltr;
        }
        .note-btn { 
            background: none; border: 1px solid var(--border-gold); color: var(--gold);
            font-size: 10px; padding: 4px 10px; border-radius: 4px; cursor: pointer;
            margin-bottom: 10px; transition: 0.3s;
        }
        .note-btn:hover { background: var(--gold-light); }

        /* Интерфейс */
        .ui-el { transition: 0.4s ease; opacity: 1; pointer-events: auto; }
        .ui-hidden { transform: translateY(20px); opacity: 0; pointer-events: none; }
        .ui-panel {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(10,10,10,0.95); backdrop-filter: blur(15px);
            padding: 10px 25px; border-radius: 50px; display: flex; gap: 20px;
            border: 1px solid var(--border-gold); z-index: 3000;
        }
        .font-controls {
            position: fixed; top: 20px; right: 20px; z-index: 3000;
            background: rgba(0,0,0,0.85); padding: 5px 15px; border-radius: 30px;
            display: flex; align-items: center; border: 1px solid var(--border-gold);
        }
        .page-indicator {
            position: fixed; top: 20px; left: 20px; z-index: 3000;
            background: rgba(0,0,0,0.85); color: var(--gold);
            padding: 8px 18px; border-radius: 20px; font-size: 13px; border: 1px solid var(--border-gold);
        }
        .btn-ui { background: none; border: none; color: var(--gold); cursor: pointer; font-weight: bold; font-size: 13px; text-transform: uppercase; }

        /* Режимы */
        .mushaf-mode .translation { display: none !important; }
        .bismillah { font-family: 'KFGQPC'; font-size: 1.5em; color: var(--gold); margin: 30px 0; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="text-align:center; color:var(--gold); letter-spacing:4px; font-weight: 300;">MUSHAF ELITE</h1>
    <div id="resume-box" style="display:none; margin-bottom:20px;">
        <button class="surah-card" style="width:100%; border-color:var(--gold)" onclick="resumeReading()">
            <span id="resume-text" style="color: var(--gold);">Продолжить чтение...</span>
        </button>
    </div>
    <div id="surah-list"></div>
</div>

<div id="reader">
    <div class="page-indicator ui-el" id="page-indicator">Страница 1</div>
    
    <div class="font-controls ui-el">
        <button class="btn-ui" onclick="changeFont(-2)">−</button>
        <span id="f-size" style="margin:0 15px; font-size: 14px; color: #fff;">32</span>
        <button class="btn-ui" onclick="changeFont(2)">+</button>
    </div>

    <div id="pagesContainer" class="pages-container" onclick="handleBgClick(event)"></div>

    <div class="ui-panel ui-el" id="uiBox">
        <button class="btn-ui" onclick="closeReader()">Меню</button>
        <button class="btn-ui" onclick="toggleMode()">Режим</button>
    </div>
</div>

<script>
    let isMushaf = false;
    let uiVisible = true;
    let activeSura = null;

    async function init() {
        const last = localStorage.getItem('last_read');
        if(last) {
            const data = JSON.parse(last);
            document.getElementById('resume-box').style.display = 'block';
            document.getElementById('resume-text').innerText = `Продолжить: ${data.name}, стр ${data.page}`;
        }

        const r = await fetch('https://api.alquran.cloud/v1/surah');
        const d = await r.json();
        const list = document.getElementById('surah-list');
        d.data.forEach(s => {
            list.innerHTML += `
                <div class="surah-card" onclick="loadSurah(${s.number})">
                    <span style="color:#888; font-size:0.9rem">${s.number}.</span>
                    <span style="flex-grow:1; margin-left:15px; font-weight:500;">${s.englishName}</span>
                    <span style="font-family:Amiri; color:var(--gold); font-size:1.4rem">${s.name}</span>
                </div>`;
        });
    }

    async function loadSurah(num, targetPage = 1) {
        activeSura = num;
        const container = document.getElementById('pagesContainer');
        document.getElementById('reader').style.display = 'block';
        container.innerHTML = '<div style="margin:auto; color:var(--gold); letter-spacing:2px;">ОТКРЫВАЕМ СВЯЩЕННУЮ КНИГУ...</div>';

        try {
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/editions/quran-uthmani,ru.kuliev`);
            const data = await res.json();
            const ar = data.data[0].ayahs;
            const ru = data.data[1].ayahs;

            // Разбивка (по 6 аятов на страницу для красоты)
            const breaks = [];
            for(let i=6; i<ar.length; i+=6) breaks.push(i);
            breaks.push(ar.length);

            let html = '';
            let start = 0;
            breaks.forEach((br, idx) => {
                let pageAyahs = ar.slice(start, br);
                html += `<div class="page" data-page="${idx+1}"><div class="page-content">`;
                if(idx === 0) {
                    html += `<div style="font-family:'Amiri'; font-size:2.2rem; color:var(--gold); margin-bottom:10px">${data.data[0].name}</div>`;
                    if(num !== 9 && num !== 1) html += `<div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>`;
                }
                html += `<div class="quran-text">`;
                pageAyahs.forEach(a => {
                    const absNum = a.number;
                    const suraNum = a.numberInSurah;
                    const savedNote = localStorage.getItem(`note_${num}_${suraNum}`) || '';
                    let text = a.text;
                    if(suraNum === 1 && num !== 1 && num !== 9) text = text.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ", "");
                    
                    html += `
                    <div class="ayah-wrapper" onclick="playAyah(${absNum}, event)">
                        <span>${text} <span class="ayah-num">﴿${suraNum}﴾</span></span>
                        <div class="translation">${ru[suraNum-1].text}</div>
                        <button class="note-btn" onclick="toggleNote(${suraNum}, event)">ЗАМЕТКА</button>
                        <textarea class="note-area" id="note-${suraNum}" 
                            onclick="event.stopPropagation()"
                            onblur="saveNote(${num}, ${suraNum}, this.value)" 
                            placeholder="Ваша заметка к аяту...">${savedNote}</textarea>
                    </div>`;
                });
                html += `</div></div></div>`;
                start = br;
            });

            container.innerHTML = html;
            updatePageInfo(targetPage, breaks.length);
            
            setTimeout(() => {
                const pages = container.querySelectorAll('.page');
                if(pages[targetPage-1]) pages[targetPage-1].scrollIntoView();
            }, 100);

            container.onscroll = () => {
                const cur = Math.round(Math.abs(container.scrollLeft) / container.clientWidth) + 1;
                updatePageInfo(cur, breaks.length);
            };

        } catch(e) { container.innerHTML = "Ошибка загрузки"; }
    }

    function playAyah(id, e) {
        if(e) e.stopPropagation();
        new Audio(`https://cdn.islamic.network/quran/audio/128/ar.alafasy/${id}.mp3`).play();
    }

    function toggleNote(id, e) {
        e.stopPropagation();
        const el = document.getElementById(`note-${id}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function saveNote(s, a, v) { localStorage.setItem(`note_${s}_${a}`, v); }

    function updatePageInfo(cur, total) {
        document.getElementById('page-indicator').innerText = `Страница ${cur} из ${total}`;
        if(activeSura) {
            localStorage.setItem('last_read', JSON.stringify({id: activeSura, page: cur, name: "Сура " + activeSura}));
        }
    }

    function handleBgClick(e) {
        if(e.target.classList.contains('page-content') || e.target.classList.contains('page')) {
            uiVisible = !uiVisible;
            document.querySelectorAll('.ui-el').forEach(el => el.classList.toggle('ui-hidden', !uiVisible));
        }
    }

    function changeFont(v) {
        let s = parseInt(document.getElementById('f-size').innerText);
        s = Math.max(20, Math.min(50, s + v));
        document.documentElement.style.setProperty('--font-size', s + 'px');
        document.getElementById('f-size').innerText = s;
    }

    function toggleMode() {
        isMushaf = !isMushaf;
        document.getElementById('pagesContainer').classList.toggle('mushaf-mode', isMushaf);
    }

    function closeReader() { document.getElementById('reader').style.display = 'none'; }
    async function resumeReading() { const last = JSON.parse(localStorage.getItem('last_read')); if(last) loadSurah(last.id, last.page); }

    init();
</script>
</body>
</html>
